<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Horas - Conductor Profesional</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .back-btn {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-50%) translateY(-2px);
        }

        .title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 16px;
            opacity: 0.8;
        }

        .tabs {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            padding: 12px 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            white-space: nowrap;
            min-width: 80px;
        }

        .tab.active {
            background: rgba(255,255,255,0.2);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-ok { background: #00ff00; }
        .status-warning { background: #ffff00; }
        .status-critical { background: #ff0000; }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row.triple {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .form-row.single {
            grid-template-columns: 1fr;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            opacity: 0.9;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 16px;
            backdrop-filter: blur(10px);
        }

        input::placeholder, textarea::placeholder {
            color: rgba(255,255,255,0.7);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            background: rgba(255,255,255,0.3);
        }

        .btn {
            background: #00ff00;
            color: black;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #00cc00;
            transform: translateY(-2px);
        }

        .btn.secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .btn.secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn.danger {
            background: #ff4444;
            color: white;
        }

        .btn.danger:hover {
            background: #cc0000;
        }

        .btn.small {
            padding: 8px 15px;
            font-size: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.8;
        }

        .alert {
            background: rgba(255,165,0,0.3);
            border: 1px solid rgba(255,165,0,0.5);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .alert.critical {
            background: rgba(255,0,0,0.3);
            border-color: rgba(255,0,0,0.5);
        }

        .alert.success {
            background: rgba(0,255,0,0.3);
            border-color: rgba(0,255,0,0.5);
        }

        .time-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .time-info {
            flex: 1;
        }

        .time-type {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .time-details {
            font-size: 12px;
            opacity: 0.8;
        }

        .time-duration {
            text-align: right;
            font-weight: bold;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .calendar-day:hover {
            background: rgba(255,255,255,0.2);
        }

        .calendar-day.today {
            background: rgba(0,255,0,0.3);
            font-weight: bold;
        }

        .calendar-day.worked {
            background: rgba(0,100,255,0.3);
        }

        .calendar-day.vacation {
            background: rgba(255,165,0,0.3);
        }

        .calendar-day.sick {
            background: rgba(255,0,0,0.3);
        }

        .calendar-day.rest {
            background: rgba(128,128,128,0.3);
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .progress-bar {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: black;
        }

        .timer-display {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            font-family: monospace;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .form-row, .form-row.triple {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                margin-bottom: 5px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .timer-display {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-btn" onclick="window.close()" title="Volver">‚Üê</button>
            <h1 class="title">‚è∞ Control de Horas</h1>
            <p class="subtitle">Gesti√≥n profesional para conductores</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Panel</button>
            <button class="tab" onclick="showTab('daily')">üìÖ Diario</button>
            <button class="tab" onclick="showTab('timer')">‚è±Ô∏è Timer</button>
            <button class="tab" onclick="showTab('weekly')">üìà Semanal</button>
            <button class="tab" onclick="showTab('calendar')">üóìÔ∏è Calendario</button>
            <button class="tab" onclick="showTab('reports')">üìã Informes</button>
        </div>

        <!-- Panel Principal -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="todayDriving">0h 0m</div>
                    <div class="stat-label">Conducci√≥n Hoy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="weeklyDriving">0h 0m</div>
                    <div class="stat-label">Semanal</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dailyRest">0h 0m</div>
                    <div class="stat-label">Descanso Diario</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="weeklyRest">0h 0m</div>
                    <div class="stat-label">Descanso Semanal</div>
                </div>
            </div>

            <div id="alerts"></div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üöõ Estado Actual del Tac√≥grafo</h3>
                </div>
                
                <div class="form-row">
                    <div>
                        <label>L√≠mite Conducci√≥n Diaria</label>
                        <div class="progress-bar">
                            <div class="progress-fill" id="dailyProgress" style="width: 0%">0%</div>
                        </div>
                        <small>M√°ximo: 9h (extensible a 10h, 2 veces/semana)</small>
                    </div>
                    <div>
                        <label>L√≠mite Conducci√≥n Semanal</label>
                        <div class="progress-bar">
                            <div class="progress-fill" id="weeklyProgress" style="width: 0%">0%</div>
                        </div>
                        <small>M√°ximo: 56h</small>
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label>Tiempo hasta pr√≥ximo descanso</label>
                        <div class="stat-value" id="nextBreak">-</div>
                    </div>
                    <div>
                        <label>Tiempo hasta descanso diario</label>
                        <div class="stat-value" id="nextDailyRest">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Registro Diario -->
        <div id="daily" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìÖ Registro del D√≠a</h3>
                    <input type="date" id="selectedDate" onchange="loadDayData()">
                </div>
                
                <form id="dailyForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de Actividad</label>
                            <select id="activityType" required>
                                <option value="">Seleccionar...</option>
                                <option value="conduccion">üöõ Conducci√≥n</option>
                                <option value="trabajo">üîß Otros Trabajos</option>
                                <option value="disponibilidad">‚è≥ Disponibilidad</option>
                                <option value="descanso">üò¥ Descanso</option>
                                <option value="pausa">‚òï Pausa</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Duraci√≥n</label>
                            <div style="display: flex; gap: 10px;">
                                <div style="flex: 1;">
                                    <input type="number" id="durationHours" min="0" max="23" placeholder="Horas" style="margin-bottom: 5px;">
                                    <small style="opacity: 0.7;">Horas</small>
                                </div>
                                <div style="flex: 1;">
                                    <input type="number" id="durationMinutes" min="0" max="59" placeholder="Minutos" style="margin-bottom: 5px;">
                                    <small style="opacity: 0.7;">Minutos</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Hora Inicio</label>
                            <input type="time" id="startTime" onchange="calculateDuration()" required>
                        </div>
                        <div class="form-group">
                            <label>Hora Fin</label>
                            <input type="time" id="endTime" onchange="calculateDuration()" required>
                        </div>
                    </div>
                    
                    <div class="form-row single">
                        <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                            <button type="button" class="btn small secondary" onclick="calculateDuration()">üîÑ Calcular Duraci√≥n Autom√°tica</button>
                            <small style="display: block; margin-top: 5px; opacity: 0.7;">
                                O introduce las horas manualmente arriba
                            </small>
                        </div>
                    </div>
                    
                    <div class="form-row single">
                        <div class="form-group">
                            <label>Observaciones</label>
                            <textarea id="activityNotes" rows="2" placeholder="Detalles adicionales..."></textarea>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn">üíæ Registrar Actividad</button>
                    <button type="button" class="btn secondary" onclick="clearDailyForm()">üóëÔ∏è Limpiar</button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìã Actividades del D√≠a</h3>
                </div>
                <div id="dailyActivities"></div>
            </div>
        </div>

        <!-- Timer en Tiempo Real -->
        <div id="timer" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">‚è±Ô∏è Timer de Actividad</h3>
                </div>
                
                <div class="timer-display" id="timerDisplay">00:00:00</div>
                
                <div class="form-row single">
                    <div class="form-group">
                        <label>Actividad Actual</label>
                        <select id="currentActivity">
                            <option value="conduccion">üöõ Conducci√≥n</option>
                            <option value="trabajo">üîß Otros Trabajos</option>
                            <option value="disponibilidad">‚è≥ Disponibilidad</option>
                            <option value="descanso">üò¥ Descanso</option>
                            <option value="pausa">‚òï Pausa</option>
                        </select>
                    </div>
                </div>
                
                <div class="timer-controls">
                    <button class="btn" id="startTimer" onclick="startTimer()">‚ñ∂Ô∏è Iniciar</button>
                    <button class="btn secondary" id="pauseTimer" onclick="pauseTimer()" disabled>‚è∏Ô∏è Pausar</button>
                    <button class="btn danger" id="stopTimer" onclick="stopTimer()" disabled>‚èπÔ∏è Parar</button>
                </div>
                
                <div id="timerStatus" class="alert" style="display: none;"></div>
            </div>
        </div>

        <!-- Resumen Semanal -->
        <div id="weekly" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìà Resumen Semanal</h3>
                    <div>
                        <input type="week" id="selectedWeek" onchange="loadWeekData()">
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="weekConduccion">0h 0m</div>
                        <div class="stat-label">Conducci√≥n Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="weekTrabajo">0h 0m</div>
                        <div class="stat-label">Otros Trabajos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="weekDisponibilidad">0h 0m</div>
                        <div class="stat-label">Disponibilidad</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="weekDescanso">0h 0m</div>
                        <div class="stat-label">Descanso</div>
                    </div>
                </div>
                
                <div id="weeklyDetails"></div>
            </div>
        </div>

        <!-- Calendario -->
        <div id="calendar" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üóìÔ∏è Calendario Laboral</h3>
                    <div>
                        <input type="month" id="selectedMonth" onchange="loadCalendar()">
                    </div>
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(0,100,255,0.3);"></div>
                        <span>Trabajado</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(255,165,0,0.3);"></div>
                        <span>Vacaciones</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(255,0,0,0.3);"></div>
                        <span>Baja/Permiso</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(128,128,128,0.3);"></div>
                        <span>Descanso</span>
                    </div>
                </div>
                
                <div class="calendar-grid" id="calendarGrid"></div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Marcar d√≠a seleccionado como:</label>
                        <select id="dayType">
                            <option value="worked">Trabajado</option>
                            <option value="vacation">Vacaciones</option>
                            <option value="sick">Baja/Permiso</option>
                            <option value="rest">Descanso</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: end;">
                        <button class="btn" onclick="markSelectedDays()">‚úì Marcar D√≠as</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informes -->
        <div id="reports" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìã Informes y Estad√≠sticas</h3>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Per√≠odo del Informe</label>
                        <select id="reportPeriod">
                            <option value="week">Esta Semana</option>
                            <option value="month">Este Mes</option>
                            <option value="quarter">Este Trimestre</option>
                            <option value="year">Este A√±o</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: end;">
                        <button class="btn" onclick="generateReport()">üìä Generar Informe</button>
                        <button class="btn secondary" onclick="exportData()">üíæ Exportar Datos</button>
                    </div>
                </div>
                
                <div id="reportContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let activities = JSON.parse(localStorage.getItem('drivingActivities')) || [];
        let calendarData = JSON.parse(localStorage.getItem('calendarData')) || {};
        let timerInterval = null;
        let timerStart = null;
        let timerPaused = false;
        let selectedDays = new Set();

        // L√≠mites legales del tac√≥grafo
        const LIMITS = {
            dailyDriving: 9 * 60, // 9 horas en minutos
            dailyDrivingExtended: 10 * 60, // 10 horas (m√°ximo 2 veces/semana)
            weeklyDriving: 56 * 60, // 56 horas en minutos
            biWeeklyDriving: 90 * 60, // 90 horas en 2 semanas
            continuousDriving: 4.5 * 60, // 4.5 horas sin pausa
            dailyRest: 11 * 60, // 11 horas de descanso diario
            weeklyRest: 45 * 60, // 45 horas de descanso semanal
            breakTime: 45 // 45 minutos de pausa despu√©s de 4.5h
        };

        // Inicializar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('selectedDate').value = today;
            
            const currentWeek = getWeekString(new Date());
            document.getElementById('selectedWeek').value = currentWeek;
            
            const currentMonth = new Date().toISOString().slice(0, 7);
            document.getElementById('selectedMonth').value = currentMonth;
            
            loadDayData();
            updateDashboard();
            loadCalendar();
        });

        // Gesti√≥n de pesta√±as
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Guardar actividad diaria
        document.getElementById('dailyForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            // Calcular duraci√≥n total en minutos
            const hours = parseInt(document.getElementById('durationHours').value) || 0;
            const minutes = parseInt(document.getElementById('durationMinutes').value) || 0;
            const totalMinutes = (hours * 60) + minutes;
            
            if (totalMinutes === 0) {
                alert('‚ùå Debes introducir al menos 1 minuto de duraci√≥n o usar el c√°lculo autom√°tico');
                return;
            }
            
            if (totalMinutes > 24 * 60) {
                alert('‚ùå La duraci√≥n no puede ser mayor a 24 horas');
                return;
            }
            
            const activity = {
                id: Date.now(),
                date: document.getElementById('selectedDate').value,
                type: document.getElementById('activityType').value,
                duration: totalMinutes,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                notes: document.getElementById('activityNotes').value
            };
            
            activities.push(activity);
            activities.sort((a, b) => new Date(a.date + ' ' + a.startTime) - new Date(b.date + ' ' + b.startTime));
            
            localStorage.setItem('drivingActivities', JSON.stringify(activities));
            
            alert('‚úÖ Actividad registrada correctamente');
            clearDailyForm();
            loadDayData();
            updateDashboard();
        });

        // Limpiar formulario diario
        function clearDailyForm() {
            document.getElementById('dailyForm').reset();
            document.getElementById('durationHours').value = '';
            document.getElementById('durationMinutes').value = '';
        }

        // Calcular duraci√≥n autom√°ticamente basada en horas de inicio y fin
        function calculateDuration() {
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            if (!startTime || !endTime) {
                return;
            }
            
            const start = new Date(`2000-01-01T${startTime}:00`);
            let end = new Date(`2000-01-01T${endTime}:00`);
            
            // Si la hora de fin es menor que la de inicio, asumimos que es del d√≠a siguiente
            if (end < start) {
                end.setDate(end.getDate() + 1);
            }
            
            const diffMs = end - start;
            const diffMinutes = Math.floor(diffMs / 60000);
            
            const hours = Math.floor(diffMinutes / 60);
            const minutes = diffMinutes % 60;
            
            document.getElementById('durationHours').value = hours;
            document.getElementById('durationMinutes').value = minutes;
            
            // Mostrar confirmaci√≥n visual
            const button = event?.target;
            if (button && button.textContent.includes('Calcular')) {
                const originalText = button.textContent;
                button.textContent = `‚úÖ ${hours}h ${minutes}m calculados`;
                button.style.background = '#00ff00';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            }
        }

        // Cargar datos del d√≠a
        function loadDayData() {
            const selectedDate = document.getElementById('selectedDate').value;
            const dayActivities = activities.filter(a => a.date === selectedDate);
            
            const activitiesDiv = document.getElementById('dailyActivities');
            activitiesDiv.innerHTML = '';
            
            if (dayActivities.length === 0) {
                activitiesDiv.innerHTML = '<p style="text-align: center; opacity: 0.7;">No hay actividades registradas para este d√≠a</p>';
                return;
            }
            
            dayActivities.forEach(activity => {
                const activityDiv = document.createElement('div');
                activityDiv.className = 'time-entry';
                activityDiv.innerHTML = `
                    <div class="time-info">
                        <div class="time-type">${getActivityName(activity.type)}</div>
                        <div class="time-details">
                            ${activity.startTime} - ${activity.endTime}
                            ${activity.notes ? ` ‚Ä¢ ${activity.notes}` : ''}
                        </div>
                    </div>
                    <div class="time-duration">${formatMinutes(activity.duration)}</div>
                `;
                activitiesDiv.appendChild(activityDiv);
            });
        }

        // Actualizar dashboard
        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const todayActivities = activities.filter(a => a.date === today);
            
            // Calcular horas de hoy
            const todayDriving = todayActivities
                .filter(a => a.type === 'conduccion')
                .reduce((sum, a) => sum + a.duration, 0);
            
            document.getElementById('todayDriving').textContent = formatMinutes(todayDriving);
            
            // Calcular horas semanales
            const weekStart = getWeekStart(new Date());
            const weekActivities = activities.filter(a => {
                const activityDate = new Date(a.date);
                return activityDate >= weekStart && activityDate <= new Date();
            });
            
            const weeklyDriving = weekActivities
                .filter(a => a.type === 'conduccion')
                .reduce((sum, a) => sum + a.duration, 0);
            
            document.getElementById('weeklyDriving').textContent = formatMinutes(weeklyDriving);
            
            // Actualizar barras de progreso
            const dailyProgress = (todayDriving / LIMITS.dailyDriving) * 100;
            const weeklyProgress = (weeklyDriving / LIMITS.weeklyDriving) * 100;
            
            document.getElementById('dailyProgress').style.width = Math.min(dailyProgress, 100) + '%';
            document.getElementById('dailyProgress').textContent = Math.round(dailyProgress) + '%';
            
            document.getElementById('weeklyProgress').style.width = Math.min(weeklyProgress, 100) + '%';
            document.getElementById('weeklyProgress').textContent = Math.round(weeklyProgress) + '%';
            
            // Actualizar alertas
            updateAlerts(todayDriving, weeklyDriving);
        }

        // Actualizar alertas
        function updateAlerts(todayDriving, weeklyDriving) {
            const alertsDiv = document.getElementById('alerts');
            alertsDiv.innerHTML = '';
            
            const alerts = [];
            
            // Alertas de conducci√≥n diaria
            if (todayDriving >= LIMITS.dailyDriving) {
                alerts.push({
                    type: 'critical',
                    message: 'üö® L√≠mite diario de conducci√≥n alcanzado (9h). Descanso obligatorio.'
                });
            } else if (todayDriving >= LIMITS.dailyDriving * 0.8) {
                const remaining = LIMITS.dailyDriving - todayDriving;
                alerts.push({
                    type: 'warning',
                    message: `‚ö†Ô∏è Quedan ${formatMinutes(remaining)} de conducci√≥n diaria permitida.`
                });
            }
            
            // Alertas de conducci√≥n semanal
            if (weeklyDriving >= LIMITS.weeklyDriving) {
                alerts.push({
                    type: 'critical',
                    message: 'üö® L√≠mite semanal de conducci√≥n alcanzado (56h). Descanso semanal obligatorio.'
                });
            } else if (weeklyDriving >= LIMITS.weeklyDriving * 0.8) {
                const remaining = LIMITS.weeklyDriving - weeklyDriving;
                alerts.push({
                    type: 'warning',
                    message: `‚ö†Ô∏è Quedan ${formatMinutes(remaining)} de conducci√≥n semanal permitida.`
                });
            }
            
            alerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert ${alert.type}`;
                alertDiv.textContent = alert.message;
                alertsDiv.appendChild(alertDiv);
            });
        }

        // Timer en tiempo real
        function startTimer() {
            if (timerInterval) return;
            
            timerStart = Date.now();
            timerPaused = false;
            
            document.getElementById('startTimer').disabled = true;
            document.getElementById('pauseTimer').disabled = false;
            document.getElementById('stopTimer').disabled = false;
            
            timerInterval = setInterval(updateTimerDisplay, 1000);
            
            const activity = document.getElementById('currentActivity').value;
            document.getElementById('timerStatus').innerHTML = `‚è±Ô∏è Timer activo: ${getActivityName(activity)}`;
            document.getElementById('timerStatus').className = 'alert success';
            document.getElementById('timerStatus').style.display = 'block';
        }

        function pauseTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                timerPaused = true;
                
                document.getElementById('startTimer').disabled = false;
                document.getElementById('pauseTimer').disabled = true;
                
                document.getElementById('timerStatus').innerHTML = '‚è∏Ô∏è Timer pausado';
                document.getElementById('timerStatus').className = 'alert';
            }
        }

        function stopTimer() {
            if (timerStart) {
                const duration = Math.floor((Date.now() - timerStart) / 60000); // minutos
                const activity = document.getElementById('currentActivity').value;
                
                if (duration > 0) {
                    // Registrar autom√°ticamente la actividad
                    const now = new Date();
                    const today = now.toISOString().split('T')[0];
                    const startTime = new Date(timerStart);
                    const endTime = now;
                    
                    const newActivity = {
                        id: Date.now(),
                        date: today,
                        type: activity,
                        duration: duration,
                        startTime: startTime.toTimeString().slice(0, 5),
                        endTime: endTime.toTimeString().slice(0, 5),
                        notes: 'Registrado autom√°ticamente con timer'
                    };
                    
                    activities.push(newActivity);
                    localStorage.setItem('drivingActivities', JSON.stringify(activities));
                    
                    alert(`‚úÖ Actividad registrada: ${getActivityName(activity)} - ${formatMinutes(duration)}`);
                }
            }
            
            clearInterval(timerInterval);
            timerInterval = null;
            timerStart = null;
            timerPaused = false;
            
            document.getElementById('startTimer').disabled = false;
            document.getElementById('pauseTimer').disabled = true;
            document.getElementById('stopTimer').disabled = true;
            
            document.getElementById('timerDisplay').textContent = '00:00:00';
            document.getElementById('timerStatus').style.display = 'none';
            
            updateDashboard();
            loadDayData();
        }

        function updateTimerDisplay() {
            if (timerStart && !timerPaused) {
                const elapsed = Date.now() - timerStart;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('timerDisplay').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Cargar datos semanales
        function loadWeekData() {
            const weekString = document.getElementById('selectedWeek').value;
            const [year, week] = weekString.split('-W');
            const weekStart = getWeekStartFromString(year, week);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const weekActivities = activities.filter(a => {
                const activityDate = new Date(a.date);
                return activityDate >= weekStart && activityDate <= weekEnd;
            });
            
            // Calcular totales por tipo
            const totals = {
                conduccion: 0,
                trabajo: 0,
                disponibilidad: 0,
                descanso: 0
            };
            
            weekActivities.forEach(activity => {
                totals[activity.type] = (totals[activity.type] || 0) + activity.duration;
            });
            
            document.getElementById('weekConduccion').textContent = formatMinutes(totals.conduccion);
            document.getElementById('weekTrabajo').textContent = formatMinutes(totals.trabajo);
            document.getElementById('weekDisponibilidad').textContent = formatMinutes(totals.disponibilidad);
            document.getElementById('weekDescanso').textContent = formatMinutes(totals.descanso);
        }

        // Cargar calendario
        function loadCalendar() {
            const monthString = document.getElementById('selectedMonth').value;
            const [year, month] = monthString.split('-');
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            // D√≠as de la semana
            const dayNames = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.textContent = day;
                dayHeader.style.fontWeight = 'bold';
                dayHeader.style.textAlign = 'center';
                dayHeader.style.padding = '5px';
                calendarGrid.appendChild(dayHeader);
            });
            
            // D√≠as vac√≠os al inicio
            const startDay = (firstDay.getDay() + 6) % 7; // Lunes = 0
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                calendarGrid.appendChild(emptyDay);
            }
            
            // D√≠as del mes
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                const dateString = `${year}-${month.padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                
                // Marcar d√≠a actual
                const today = new Date().toISOString().split('T')[0];
                if (dateString === today) {
                    dayElement.classList.add('today');
                }
                
                // Aplicar estado del calendario
                if (calendarData[dateString]) {
                    dayElement.classList.add(calendarData[dateString]);
                }
                
                // Evento de clic
                dayElement.addEventListener('click', () => {
                    if (selectedDays.has(dateString)) {
                        selectedDays.delete(dateString);
                        dayElement.style.border = '';
                    } else {
                        selectedDays.add(dateString);
                        dayElement.style.border = '2px solid white';
                    }
                });
                
                calendarGrid.appendChild(dayElement);
            }
        }

        // Marcar d√≠as seleccionados
        function markSelectedDays() {
            const dayType = document.getElementById('dayType').value;
            
            selectedDays.forEach(dateString => {
                calendarData[dateString] = dayType;
            });
            
            localStorage.setItem('calendarData', JSON.stringify(calendarData));
            selectedDays.clear();
            loadCalendar();
            
            alert(`‚úÖ ${selectedDays.size} d√≠a(s) marcado(s) como ${dayType}`);
        }

        // Generar informe
        function generateReport() {
            const period = document.getElementById('reportPeriod').value;
            const reportContent = document.getElementById('reportContent');
            
            // Aqu√≠ ir√≠a la l√≥gica del informe seg√∫n el per√≠odo
            reportContent.innerHTML = `
                <div class="card">
                    <h4>üìä Informe de ${period}</h4>
                    <p>Funcionalidad de informes en desarrollo...</p>
                </div>
            `;
        }

        // Exportar datos
        function exportData() {
            const data = {
                activities: activities,
                calendarData: calendarData,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `control-horas-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Funciones auxiliares
        function formatMinutes(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins}m`;
        }

        function getActivityName(type) {
            const names = {
                conduccion: 'üöõ Conducci√≥n',
                trabajo: 'üîß Otros Trabajos',
                disponibilidad: '‚è≥ Disponibilidad',
                descanso: 'üò¥ Descanso',
                pausa: '‚òï Pausa'
            };
            return names[type] || type;
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Lunes
            return new Date(d.setDate(diff));
        }

        function getWeekString(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const week = getWeekNumber(d);
            return `${year}-W${week.toString().padStart(2, '0')}`;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function getWeekStartFromString(year, week) {
            const simple = new Date(year, 0, 1 + (week - 1) * 7);
            const dow = simple.getDay();
            const ISOweekStart = simple;
            if (dow <= 4)
                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            else
                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            return ISOweekStart;
        }
    </script>
</body>
</html>